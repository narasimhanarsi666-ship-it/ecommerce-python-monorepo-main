version: 2.1

jobs:
  pytest-runner:
    docker:
      - image: cimg/python:3.10

    steps:
      - checkout

      # ✅ Install dependencies
      - run:
          name: Install Dependencies
          command: |
            pip install -r requirements.txt
            pip install pytest

      # ✅ Detect changed test files
      - run:
          name: Detect Changed Test Files
          command: |
            git fetch origin main

            CHANGED_TEST_FILES=$(git diff --name-only origin/main...HEAD | grep "^tests/.*\.py" || true)

            echo "$CHANGED_TEST_FILES" > changed_tests.txt

            echo "Changed test files:"
            cat changed_tests.txt

      # ✅ Run pytest EXACTLY like terminal runner + Save pytest.log
      - run:
          name: Run Pytest (Exact Runner Output)
          command: |
            echo "============================= pytest runner ============================="

            if [ ! -s changed_tests.txt ]; then
              echo "No changed test files → running full suite"
              pytest tests/ 2>&1 | tee pytest.log
            else
              echo "Running ONLY changed test files:"
              cat changed_tests.txt

              # ✅ This matches: pytest tests/test_sample.py
              pytest $(cat changed_tests.txt) 2>&1 | tee pytest.log
            fi

      # ✅ Store pytest.log artifact
      - store_artifacts:
          path: pytest.log
          destination: pytest.log

      # ✅ Store changed test file list artifact
      - store_artifacts:
          path: changed_tests.txt
          destination: changed_tests.txt

workflows:
  pr-workflow:
    jobs:
      - pytest-runner
