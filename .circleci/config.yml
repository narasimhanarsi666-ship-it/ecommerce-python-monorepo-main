version: 2.1

setup: true

orbs:
  continuation: circleci/continuation@0.4.0

jobs:
  # -----------------------------------
  # Step 1: Continuation Setup Job
  # -----------------------------------
  detect-and-continue:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout
      - continuation/continue:
          configuration_path: .circleci/continue.yml

  # -----------------------------------
  # Step 2: Pytest Runner Job
  # -----------------------------------
  pytest-runner:
    docker:
      - image: cimg/python:3.10
    steps:
      - checkout

      # Install dependencies
      - run:
          name: Install Dependencies
          command: |
            pip install -r requirements.txt
            pip install pytest

      # Run pytest and save log
      - run:
          name: Run Pytest
          command: |
            echo "Running pytest..."
            pytest tests/ > pytest.log 2>&1 || true

      # Upload only pytest.log as artifact
      - store_artifacts:
          path: pytest.log
          destination: pytest-runner/pytest.log

workflows:
  setup-workflow:
    jobs:
      - detect-and-continue
      - pytest-runner:
          requires:
            - detect-and-continue
