version: 2.1

jobs:
  pytest-runner:
    docker:
      - image: cimg/python:3.10

    steps:
      - checkout

      # -------------------------------------------------------
      # Step 1: Install Dependencies
      # -------------------------------------------------------
      - run:
          name: Install Dependencies
          command: |
            pip install -r requirements.txt
            pip install pytest

      # -------------------------------------------------------
      # Step 2: Detect ONLY Changed Test Files in PR (Accurate)
      # -------------------------------------------------------
      - run:
          name: Detect Changed Test Files (PR Only)
          command: |
            echo "Fetching main branch..."
            git fetch origin main

            echo "Finding merge-base..."
            BASE=$(git merge-base origin/main HEAD)

            echo "Detecting changed python test files..."
            CHANGED_TEST_FILES=$(git diff --name-only $BASE HEAD | grep "^tests/.*\.py" || true)

            echo "$CHANGED_TEST_FILES" > changed_tests.txt

            echo "Changed test files:"
            cat changed_tests.txt

      # -------------------------------------------------------
      # Step 3: Run ONLY Changed Tests + Save Exact Output
      # -------------------------------------------------------
      - run:
          name: Run ONLY Changed Tests (Exact pytest runner output)
          command: |
            if [ ! -s changed_tests.txt ]; then
              echo "No changed test files found â†’ skipping pytest run"
              echo "NO_TESTS_CHANGED" > pytest.log
              exit 0
            fi

            echo "ðŸš€ Running ONLY these test files:"
            cat changed_tests.txt

            # âœ… Fix module imports (services package)
            export PYTHONPATH=$PWD

            # âœ… Run only changed files and store exact output
            pytest $(cat changed_tests.txt) 2>&1 | tee pytest.log || true

      # -------------------------------------------------------
      # Step 4: Verify pytest.log Created
      # -------------------------------------------------------
      - run:
          name: Verify pytest.log
          command: |
            echo "pytest.log created successfully:"
            ls -l pytest.log
            head -20 pytest.log

      # -------------------------------------------------------
      # Step 5: Store Artifacts
      # -------------------------------------------------------
      - store_artifacts:
          path: pytest.log
          destination: pytest.log

      - store_artifacts:
          path: changed_tests.txt
          destination: changed_tests.txt

workflows:
  pr-workflow:
    jobs:
      - pytest-runner
